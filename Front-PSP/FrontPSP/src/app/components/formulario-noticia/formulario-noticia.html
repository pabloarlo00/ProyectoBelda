<div class="container mt-5 mb-5">
  <div class="card border-0 shadow-sm rounded-4">
    <div class="card-header bg-primary text-white py-3">
      <h3 class="mb-0">
        <i
          class="bi"
          [ngClass]="form.get('_id')?.value ? 'bi-pencil-square' : 'bi-plus-circle'"
        ></i>
        {{ form.get('_id')?.value ? ' Editar Noticia' : ' Nueva Noticia' }}
      </h3>
    </div>

    <div class="card-body p-4">
      <form [formGroup]="form" (ngSubmit)="guardar()">
        <div class="mb-3">
          <label class="form-label fw-bold">Título</label>
          <input
            type="text"
            formControlName="titulo"
            class="form-control"
            [class.is-invalid]="form.get('titulo')?.invalid && form.get('titulo')?.touched"
            placeholder="Escribe un título impactante..."
          />
          <div class="invalid-feedback">El título debe tener al menos 5 caracteres.</div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Subtítulo</label>
          <input
            type="text"
            formControlName="subtitulo"
            class="form-control"
            placeholder="Resumen breve de la noticia"
          />
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Autor</label>
            <input
              type="text"
              formControlName="autor"
              class="form-control"
              placeholder="Nombre del redactor"
            />
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold d-flex justify-content-between">
              Sección
              <a
                href="javascript:void(0)"
                (click)="toggleNuevaSeccion()"
                class="small text-decoration-none"
              >
                {{ crearNuevaSeccion ? 'Ver existentes' : '+ Crear nueva' }}
              </a>
            </label>

            @if (!crearNuevaSeccion) {
            <select
              formControlName="seccion"
              class="form-select"
              (change)="alCambiarSeccion($event)"
            >
              <option value="" disabled selected>Selecciona sección...</option>
              @for (sec of seccionesConIconos; track sec.nombre) {
              <option [value]="sec.nombre">{{ sec.nombre }}</option>
              }
            </select>
            } @else {
            <div class="input-group">
              <span class="input-group-text bg-primary text-white"
                ><i class="bi bi-plus-lg"></i
              ></span>
              <input
                type="text"
                formControlName="seccion"
                class="form-control"
                placeholder="Nombre de la sección..."
              />
            </div>
            }
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Icono de Sección</label>

            @if (!crearNuevaSeccion) {
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0">
                <i [class]="form.get('iconoSeccion')?.value || 'bi-tag'"></i>
              </span>
              <input
                type="text"
                formControlName="iconoSeccion"
                class="form-control bg-light border-start-0"
                readonly
              />
            </div>
            } @else {
            <div class="dropdown">
              <div class="input-group" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="input-group-text bg-white border-end-0">
                  <i [class]="form.get('iconoSeccion')?.value || 'bi-search'"></i>
                </span>
                <input
                  type="text"
                  class="form-control border-start-0"
                  placeholder="Buscar icono..."
                  [(ngModel)]="filtroIcono"
                  [ngModelOptions]="{ standalone: true }"
                />
              </div>
              <ul
                class="dropdown-menu w-100 p-2 shadow border-0 mt-1"
                [class.show]="filtroIcono.length > 0"
                style="max-height: 200px; overflow-y: auto"
              >
                <div class="row g-2 m-0">
                  @for (icon of iconosFiltrados; track icon) {
                  <div class="col-3 text-center">
                    <button
                      type="button"
                      (click)="seleccionarIcono(icon)"
                      class="btn btn-outline-primary btn-sm w-100 border-0"
                    >
                      <i [class]="icon" class="fs-4"></i>
                    </button>
                  </div>
                  } @empty {
                  <li class="small text-muted text-center py-2">No hay resultados</li>
                  }
                </div>
              </ul>
            </div>
            }
          </div>
        </div>

        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label fw-bold mb-0">Galería de Imágenes (URLs)</label>
            <button
              type="button"
              (click)="agregarImagen()"
              class="btn btn-sm btn-outline-primary rounded-pill"
            >
              <i class="bi bi-plus-lg"></i> Añadir otra imagen
            </button>
          </div>

          <div formArrayName="imagenes">
            @for (control of imagenes.controls; track $index) {
            <div class="card mb-3 border-0 bg-light shadow-sm">
              <div class="card-body p-2">
                <div class="input-group">
                  <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-link-45deg text-muted"></i>
                  </span>
                  <input
                    type="text"
                    [formControlName]="$index"
                    class="form-control border-start-0"
                    placeholder="https://enlace-a-tu-foto.jpg"
                  />

                  @if (imagenes.length > 1) {
                  <button
                    class="btn btn-white text-danger border"
                    type="button"
                    (click)="quitarImagen($index)"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                  }
                </div>

                @if (control.value) {
                <div class="mt-2 text-center">
                  <img
                    [src]="control.value"
                    class="img-thumbnail animate__fadeIn shadow-sm"
                    style="max-height: 120px; object-fit: cover"
                    (error)="imgError($event)"
                  />
                </div>
                }
              </div>
            </div>
            }
          </div>
          <small class="text-muted"
            >Introduce URLs de imágenes. La previsualización aparecerá automáticamente.</small
          >
        </div>

        <div class="mb-4">
          <label class="form-label fw-bold">Contenido de la Noticia</label>
          <textarea
            formControlName="contenido"
            class="form-control"
            rows="6"
            placeholder="Escribe aquí el cuerpo completo de la noticia..."
          ></textarea>
        </div>

        <div class="d-flex gap-2 pt-3 border-top">
          <button type="submit" [disabled]="form.invalid" class="btn btn-primary px-4 shadow-sm">
            <i class="bi bi-cloud-arrow-up me-1"></i>
            {{ form.get('_id')?.value ? 'Actualizar Cambios' : 'Publicar Noticia' }}
          </button>
          <button type="button" (click)="volver()" class="btn btn-light text-secondary border px-4">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
